const bijoy_map = {
    "|": "।", "i¨": "র‌্য", "ª¨": "্র্য", "°": "ক্ক", "±": "ক্ট", "³": "ক্ত", 
    "K¡": "ক্ব", "¯Œ": "স্ক্র", " ̄‹": "স্ক", "µ": "ক্র", "K¬": "ক্ল", "¶": "ক্ষ", 
    "ÿ": "ক্ষ", "·": "ক্স", "¸": "গু", "»": "গ্ধ", "Mœ": "গ্ন", "¤§": "ম্ম", 
    "M¥": "গ্ম", "M­": "গ্ল", "¼": "ঙ্ক", "•¶": "ঙ্ক্ষ", "•L": "ঙ্খ", "½": "ঙ্গ",
    "•N": "ঙ্ঘ", "”P": "চ্চ", "”Q": "চ্ছ", "”Q¡": "চ্ছ্ব", "”T": "চ্ঞ", "¾¡": "জ্জ্ব", 
    "g¥": "ম্ন", "¾": "জ্জ", "fz¨": "ভ্যু", "À": "জ্ঝ", "Á": "জ্ঞ", "R¡": "জ্ব",
    "Â": "ঞ্চ", "Ã": "ঞ্ছ", "Ä": "ঞ্জ", "Å": "ঞ্ঝ", "Æ": "ট্ট", "U¡": "ট্ব",
    "U¥": "ট্ম", "Ç": "ড্ড", "È": "ণ্ট", "É": "ণ্ঠ", "Ý": "ন্স", "Ê": "ণ্ড", 
    "š‘": "ন্তু", "Y^": "ণ্ব", "Ë": "ত্ত", "Ë¡": "ত্ত্ব", "Ì": "ত্থ", "Z¥": "ত্ম", 
    "š—¡": "ন্ত্ব", "Z¡": "ত্ব", "Î": "ত্র", "_¡": "থ্ব", "˜M": "দ্গ", "˜N": "দ্ঘ",
    "Ï": "দ্দ", "ï": "শু", "×": "দ্ধ", "Ø": "দ্ব", "™¢": "দ্ভ", "Ù": "দ্ম", 
    "`ª“": "দ্রু", "aŸ": "ধ্ব", "a¥": "ধ্ম", "›U": "ন্ট", "Ú": "ন্ঠ", "Û": "ন্ড", 
    "šÍ": "ন্ত", "š—": "ন্ত", "š¿": "ন্ত্র", "š’": "ন্থ", "›`": "ন্দ", "›Ø": "ন্দ্ব", 
    "Ü": "ন্ধ", "bœ": "ন্ন", "š^": "ন্ব", "b¥": "ন্ম", "Þ": "প্ট", "ß": "প্ত", 
    "cœ": "প্ন", "à": "প্প", "cø": "প্ল", "kø": "শ্ল", "jø": "ল্ল", "c­": "প্ল", 
    "á": "প্স", "d¬": "ফ্ল", "â": "ব্জ", "ã": "ব্দ", "ä": "ব্ধ", "eŸ": "ব্ব", 
    "e­": "ব্ল", "å": "ভ্র", "gœ": "ম্ন", "¤ú": "ম্প", "ç": "ম্ফ", "¤^": "ম্ব", 
    "¤¢": "ম্ভ", "¤£": "ম্ভ্র", "¤¬": "ম্ল", "j¨": "ক্য", "l¨": "দ্য", "i“": "রু", 
    "iƒ": "রূ", "…": "ৃ", "†": "ে", "‡": "ে", "ë": "্র", "ü": "ু", 
    "ú": "ু", "û": "হু", "ˆ": "ৈ", "‰": "ৈ", "Š": "ৗ", "Œ": "ৌ",
    "•": "ঙ্", "œ": "ণ", "Ÿ": "্ব", "¡": "্ব", "¢": "্ভ", "£": "্ভ্র", 
    "¥": "্ম", "¦": "্ব", "§": "্ম", "©": "র্", "ª": "্র", "«": "্র", 
    "¬": "্ল", "­": "্ল", "¯‘": "স্ত", " ̄’": "স্থ", "¯‹": "স্ক", "®‹": "স্ক", 
    "¯ú": "স্প", " ̄^": "স্ব", "¯§": "স্ম", "¯ø": "স্ল", "Av": "আ", "B": "ই",
    "C": "ঈ", "D": "উ", "E": "ঊ", "F": "ঋ", "G": "এ", "H": "ঐ", 
    "I": "ও", "J": "ঔ", "K": "ক", "L": "খ", "M": "গ", "N": "ঘ", 
    "O": "ঙ", "P": "চ", "Q": "ছ", "R": "জ", "S": "ঝ", "T": "ঞ", 
    "U": "ট", "V": "ঠ", "W": "ড", "X": "ঢ", "Y": "ণ", "Z": "ত",
    "r": "ৎ", "_": "থ", "`": "দ", "a": "ধ", "b": "ন", "c": "প", 
    "d": "ফ", "e": "ব", "f": "ভ", "g": "ম", "h": "য", "i": "র", 
    "j": "ল", "k": "শ", "l": "ষ", "m": "স", "n": "হ", "o": "ড়", 
    "p": "ঢ়", "q": "য়", "s": "ং", "t": "ঃ", "u": "ঁ", "w": "ি", 
    "‚": "ূ", "x": "ী", "y": "ু", "z": "ু", "v": "া", "0": "০", 
    "1": "১", "2": "২", "3": "৩", "4": "৪", "5": "৫", "6": "৬", 
    "7": "৭", "8": "৮", "9": "৯", "&": "্", "‘": "‘", "’": "’", 
    "“": "“", "”": "”", "ô": "ষ্ঠ", "μ": "ক্র", "^": "্ব", " ̄Í": "স্ত",
    "Ð": "ণ্ড", " ̧": "গু", "÷": "স্ট", "ð": "শ্চ", "æ": "ু", "„": "ৃ",
    " ̈": "্য", "A": "অ", "Ö": "্র", "ó": "ষ্ট", "~": "ূ", "¯ú": "স্প",
    "í": "ল্প", "²": "ক্ষ্ম", "ý": "হ্ন", "nè": "হ্ণ", "¶œ": "ক্ষ্ন", "¶è": "ক্ষ্ণ", 
    "Ñ": "—", "Ô": "‘", "Õ": "’", "Ò": "“", "Ó": "”", "র্": "র্"
};

const isBanglaBanjonborno = (c) => c && "কখগঘঙচছজঝঞটঠডঢণতথদধনপফবভমযরলশষসহড়ঢ়য়ৎংঃঁ".includes(c);
const isBanglaPreKar = (c) => c && "িেৈ".includes(c);
const isBanglaHalant = (c) => c === '্';

function pullRephBack(text) {
    return text.replace(/([ক-হড়ঢ়য়ংঃঁ]+)(র্)([ািীুূৃেৈোৌ]?)/g, '$2$1$3');
}

function bijoyToUnicode(text) {
    const sortedKeys = Object.keys(bijoy_map).sort((a, b) => b.length - a.length);
    for (const key of sortedKeys) {
        const escapedKey = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedKey, 'g');
        text = text.replace(regex, bijoy_map[key]);
    }

    text = text.replace(/\.\.\./g, 'ৃ')           
               .replace(/…/g, 'ৃ');
    text = pullRephBack(text);

    let processedText = "";
    for (let i = 0; i < text.length; i++) {
       if (isBanglaPreKar(text[i]) && i + 1 < text.length) {
             let clusterEnd = i + 1;
             while (clusterEnd < text.length) {
                if (isBanglaBanjonborno(text[clusterEnd]) && isBanglaHalant(text[clusterEnd + 1])) {
                    clusterEnd += 2;
                } else if (isBanglaBanjonborno(text[clusterEnd])) {
                    clusterEnd += 1;
                    break;
                } else {
                    break;
                }
            }
            const cluster = text.substring(i + 1, clusterEnd);
            processedText += cluster + text[i];
            i = clusterEnd - 1;
        } else {
            processedText += text[i];
        }
    }
    return processedText;
}

module.exports = { bijoyToUnicode };